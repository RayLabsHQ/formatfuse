---
import Layout from '@/layouts/Layout.astro';
import GenericArchiveExtractor from '@/components/converters/GenericArchiveExtractor';
import type {
  ArchiveFormatMeta,
  ArchiveIntentModifier,
  SupportedArchiveFormat,
} from '@/data/archiveFormats';
import {
  archiveFormatsList,
  archiveModifiersList,
  buildDefaultContent,
  getExampleArchive,
  isArchiveModifierApplicable,
} from '@/pages/extract/archive/page-data';

interface Props {
  format: SupportedArchiveFormat;
  formatMeta: ArchiveFormatMeta;
  modifier?: ArchiveIntentModifier;
}

const { format, formatMeta, modifier } = Astro.props as Props;

const defaultContent = buildDefaultContent(formatMeta);
const activeContent = modifier?.content ?? defaultContent;
const heroTagline = modifier?.heroTagline ?? formatMeta.heroTagline;

const formatDisplayName = formatMeta.name;
const title = modifier
  ? `${formatDisplayName} Extractor ${modifier.titleSuffix} - Browser-Based Archive Viewer`
  : `Extract ${formatDisplayName} Archives Online - Free Browser Tool`;

const description = modifier
  ? `${modifier.metaDescription} ${formatMeta.description}`
  : `${formatMeta.description} Extract and preview ${formatDisplayName} archives instantly in your browser—no uploads, 100% private.`;

const keywordPool = new Set<string>([
  `${formatDisplayName.toLowerCase()} extractor`,
  `open ${formatDisplayName.toLowerCase()} archives online`,
  `${format} viewer`,
  `${format} archive tool`,
  'archive extractor',
  'browse archives in browser',
]);
activeContent.seoKeywords.forEach((keyword) => keywordPool.add(keyword));
if (modifier) {
  keywordPool.add(modifier.label.toLowerCase());
  keywordPool.add(`${modifier.slug.replace(/-/g, ' ')} archive extractor`);
}
const keywords = Array.from(keywordPool).join(', ');

const example = getExampleArchive(format);
const acceptedExtensions = formatMeta.acceptedExtensions.join(', ');

const extractorFormatMap: Record<SupportedArchiveFormat, string> = {
  zip: 'zip',
  rar: 'rar',
  '7z': '7z',
  tar: 'tar',
  'tar-gz': 'tar',
  'tar-bz2': 'tar',
  'tar-xz': 'tar',
  gz: 'gz',
  bz2: 'bz2',
  xz: 'xz',
  iso: 'iso',
  cab: 'cab',
  ar: 'ar',
  cpio: 'cpio',
};

const canonicalToolSlugMap: Record<SupportedArchiveFormat, string> = {
  zip: 'zip-extract',
  rar: 'rar-extract',
  '7z': '7z-extract',
  tar: 'tar-extract',
  'tar-gz': 'tar-extract',
  'tar-bz2': 'tar-extract',
  'tar-xz': 'tar-extract',
  gz: 'gz-extract',
  bz2: 'bz2-extract',
  xz: 'xz-extract',
  iso: 'iso-extract',
  cab: 'cab-extract',
  ar: 'ar-extract',
  cpio: 'cpio-extract',
};

const canonicalToolSlug = canonicalToolSlugMap[format];
const ogImagePath = canonicalToolSlug
  ? `/tools/${canonicalToolSlug}/index.png`
  : '/tools/multi-extract/index.png';

const structuredPath = Astro.url.pathname.endsWith('/')
  ? Astro.url.pathname
  : `${Astro.url.pathname}/`;

const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'WebApplication',
  name: title,
  description,
  url: `${Astro.site?.origin ?? 'https://formatfuse.com'}${structuredPath}`,
  applicationCategory: 'UtilitiesApplication',
  operatingSystem: 'Any',
  audience: modifier?.label ?? 'General archive workflows',
  offers: {
    '@type': 'Offer',
    price: '0',
    priceCurrency: 'USD',
  },
  featureList: [
    `${formatDisplayName} archive extraction`,
    ...activeContent.valueProps,
  ],
};

const faqData = {
  '@type': 'FAQPage',
  mainEntity: activeContent.faq.map((item) => ({
    '@type': 'Question',
    name: item.question,
    acceptedAnswer: {
      '@type': 'Answer',
      text: item.answer,
    },
  })),
};

const breadcrumbItems = [
  {
    '@type': 'ListItem',
    position: 1,
    name: 'FormatFuse',
    item: 'https://formatfuse.com/',
  },
  {
    '@type': 'ListItem',
    position: 2,
    name: 'Archive Tools',
    item: 'https://formatfuse.com/tools#archive',
  },
  {
    '@type': 'ListItem',
    position: 3,
    name: `${formatDisplayName} Extractor`,
    item: `https://formatfuse.com/extract/archive/${format}/`,
  },
];

if (modifier) {
  breadcrumbItems.push({
    '@type': 'ListItem',
    position: 4,
    name: `${modifier.label} workflow`,
    item: `https://formatfuse.com${structuredPath}`,
  });
}

const breadcrumbData = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: breadcrumbItems,
};

const pageFaqItems = activeContent.faq;

const relatedLinkMap = new Map<string, { href: string; label: string }>();
const addRelatedLink = (href: string, label: string) => {
  if (!relatedLinkMap.has(href)) {
    relatedLinkMap.set(href, { href, label });
  }
};

if (canonicalToolSlug) {
  addRelatedLink(`/tools/${canonicalToolSlug}/`, `${formatDisplayName} extractor home`);
}

if (modifier) {
  addRelatedLink(`/extract/archive/${format}/`, `${formatDisplayName} extractor (all workflows)`);
  const siblingModifiers = archiveModifiersList
    .filter((item) => item.slug !== modifier.slug && isArchiveModifierApplicable(item, format))
    .slice(0, 2);
  siblingModifiers.forEach((item) => {
    addRelatedLink(`/extract/archive/${format}/${item.slug}/`, `${item.label} workflow`);
  });
}

const otherFormats = archiveFormatsList
  .filter((item) => item.id !== format)
  .slice(0, 3);
otherFormats.forEach((item) => {
  addRelatedLink(`/extract/archive/${item.id}/`, `Extract ${item.name}`);
});

addRelatedLink('/tools/multi-extract/', 'Universal archive extractor');

const relatedLinks = Array.from(relatedLinkMap.values());
---

<Layout
  title={title}
  description={description}
  keywords={keywords}
  ogImage={ogImagePath}
  toolType="archive"
>
  <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
  <script type="application/ld+json" set:html={JSON.stringify(faqData)} />
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbData)} />

  <main>
    <div class="container mx-auto px-4 py-10 lg:py-14">
      <div class="text-center max-w-4xl mx-auto">
        {modifier && (
          <span class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-primary/10 text-primary text-sm font-medium mb-4">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 8v4l3 3" />
            </svg>
            {modifier.label} Workflow
          </span>
        )}
        <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold tracking-tight mb-4">
          {formatDisplayName} Archive Extractor
          {modifier ? (
            <span class="block text-xl sm:text-2xl font-semibold text-muted-foreground mt-2">
              Optimized for {modifier.label.toLowerCase()}
            </span>
          ) : (
            <span class="block text-xl sm:text-2xl font-semibold text-muted-foreground mt-2">
              Extract {formatDisplayName} archives directly in your browser
            </span>
          )}
        </h1>
        <p class="text-lg text-muted-foreground mb-2">{heroTagline}</p>
        <p class="text-sm text-muted-foreground">
          Works entirely on your device—no uploads, no installs. Preview folders, unlock encrypted sections, and download only what you need.
        </p>
      </div>

      <div class="mt-10 lg:mt-14">
        <GenericArchiveExtractor
          client:load
          format={extractorFormatMap[format]}
          formatName={formatDisplayName}
          formatDescription={formatMeta.formatSummary}
          acceptedExtensions={acceptedExtensions}
        />
      </div>

      <section class="mt-16 lg:mt-20 max-w-5xl mx-auto">
        <div class="border border-border rounded-3xl p-6 sm:p-10 bg-card/60 backdrop-blur">
          <div class="grid gap-6">
            <div class="text-left sm:text-center max-w-3xl mx-auto">
              <p class="text-lg text-muted-foreground leading-relaxed">{activeContent.summary}</p>
            </div>

            <div class="bg-muted/30 rounded-2xl p-6 sm:p-8">
              <h2 class="text-xl font-semibold flex items-center gap-2 mb-5">
                <svg class="w-5 h-5 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M4 7h16M4 17h16M10 11h4" />
                </svg>
                Example Archive
              </h2>
              <div class="grid sm:grid-cols-2 gap-4">
                <div class="bg-background rounded-xl p-4 border border-border">
                  <p class="text-sm text-muted-foreground mb-2">Archive Name</p>
                  <code class="text-base font-mono font-semibold break-all">{example.name}</code>
                </div>
                <div class="bg-background rounded-xl p-4 border border-primary/30">
                  <p class="text-sm text-muted-foreground mb-2">Typical Usage</p>
                  <span class="text-base text-primary-foreground/80">{example.note}</span>
                </div>
              </div>
            </div>

            <div class="grid md:grid-cols-2 gap-5">
              <div class="bg-background/50 border border-border rounded-xl p-6">
                <h3 class="text-lg font-semibold mb-3">Why teams choose this tool</h3>
                <ul class="space-y-3 text-sm text-muted-foreground">
                  {activeContent.valueProps.map((item) => (
                    <li class="flex items-start gap-3">
                      <svg class="w-4 h-4 text-primary mt-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M5 12l5 5l10 -10" />
                      </svg>
                      <span>{item}</span>
                    </li>
                  ))}
                </ul>
              </div>
              <div class="bg-background/50 border border-border rounded-xl p-6">
                <h3 class="text-lg font-semibold mb-3">Workflow</h3>
                <ol class="list-decimal list-inside space-y-2 text-sm text-muted-foreground">
                  {activeContent.workflowSteps.map((step) => (
                    <li>{step}</li>
                  ))}
                </ol>
              </div>
            </div>

            <div class="grid md:grid-cols-2 gap-5">
              <div class="border border-border rounded-xl p-6 bg-background/40">
                <h3 class="text-lg font-semibold mb-3">Format quick facts</h3>
                <p class="text-sm text-muted-foreground mb-2">{formatMeta.description}</p>
                <p class="text-sm text-muted-foreground">
                  <strong class="font-semibold text-foreground">Supported extensions:</strong> {acceptedExtensions}
                </p>
              </div>
              <div class="border border-border rounded-xl p-6 bg-background/40">
                <h3 class="text-lg font-semibold mb-3">Best for</h3>
                <ul class="space-y-2 text-sm text-muted-foreground">
                  {activeContent.useCases.map((item) => (
                    <li class="flex items-start gap-3">
                      <svg class="w-4 h-4 text-primary mt-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 11l3 3L22 4" />
                        <path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2" />
                      </svg>
                      <span>{item}</span>
                    </li>
                  ))}
                </ul>
              </div>
            </div>

            <div class="grid md:grid-cols-2 gap-5">
              <div class="border border-destructive/40 bg-destructive/10 rounded-xl p-6">
                <h3 class="text-lg font-semibold mb-3 text-destructive">Pitfalls to watch</h3>
                <ul class="space-y-2 text-sm text-destructive-foreground/90">
                  {activeContent.pitfalls.map((item) => (
                    <li class="flex items-start gap-3">
                      <svg class="w-4 h-4 mt-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 9v4" />
                        <path d="M12 17h.01" />
                        <path d="M10 3h4l7 7l-7 11h-4L3 10z" />
                      </svg>
                      <span>{item}</span>
                    </li>
                  ))}
                </ul>
              </div>
              <div class="border border-border rounded-xl p-6 bg-background/50">
                <h3 class="text-lg font-semibold mb-3">Related links</h3>
                <div class="flex flex-wrap gap-3">
                  {relatedLinks.map(({ href, label }) => (
                    <a class="inline-flex items-center gap-2 px-4 py-2 rounded-full border border-border hover:border-primary/60 hover:text-primary text-sm transition-colors" href={href}>
                      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M5 12h14" />
                        <path d="M12 5l7 7-7 7" />
                      </svg>
                      {label}
                    </a>
                  ))}
                </div>
              </div>
            </div>

            <div class="border border-border rounded-xl p-6 bg-background/60">
              <h3 class="text-lg font-semibold mb-4">Common questions</h3>
              <div class="space-y-4">
                {pageFaqItems.map((item) => (
                  <div class="border border-border rounded-lg p-4 bg-background/40" role="region">
                    <p class="font-medium text-base mb-2">{item.question}</p>
                    <p class="text-sm text-muted-foreground leading-relaxed">{item.answer}</p>
                  </div>
                ))}
              </div>
            </div>

            <div class="border border-primary/40 bg-primary/10 rounded-2xl p-6 sm:p-8 text-center">
              <h3 class="text-2xl font-semibold mb-3 text-primary">{activeContent.ctaTitle}</h3>
              <p class="text-base text-primary-foreground/80 max-w-2xl mx-auto">{activeContent.ctaBody}</p>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>
</Layout>
